{% extends 'base.html' %}
{% load blog_tags %}
{% load crispy_forms_tags %}
{% block content %}
<div class="well">
    <div class="blog-post">
        <h2 class="blog-post-title"><a href="{{ post.get_absolute_url }}">{{ post.title|title }}</a></h2>
        <p class="blog-post-meta">
            作者：<a href="#"><span class="label label-danger">{{ post.author }}</span>&nbsp;&nbsp;</a>发布时间：{{ post.pub_time }}
            &nbsp;&nbsp;&nbsp;
            {% for cate in post.category.all %}
            <a href="{{ cate.get_absolute_url }}"><span class="label label-primary">{{cate.name}}&nbsp;</span></a>
            {% endfor %}
        </p>
    </div>
    <div class="post-content">
        {{ post.content|safe }}
    </div>
    <div class="comment-form-title">
            <span>新评论</span>
        </div>
        <!--评论列表-->
        {% crispy form %}
    <div class="comment-count">
        <h3>共有{{ post.comment_set.all.count }}条评论</h3>
    </div>
    <div class="comment">
        <!-- 第一次遍历所有根评论 -->
        <div class="comment-list">
            {% for root_comment in comment_list %}
            <div class="root-comment">
                <div class="col-sm-1 comment-avatar">
                    {% get_show_avatar root_comment.author %}
                </div>
                <div class="col-sm-11">
                    <span id="c{{ root_comment.pk }}">{{ root_comment.author.username }}</span>
                    <span class="pull-right">{{ root_comment.created }}</span>
                    <div class="comment-content">{{ root_comment.content|safe }}</div>
                    <span><a href="javascript:void(0);" class="reply pull-right" id="{{ root_comment.pk }}">回复</a></span>
                </div>
            </div>
            <!--获取所有根评论下的回复-->
            {% get_reply_of root_comment as reply_list %}
            <!-- 第二次遍历当前跟评论下的所有回复 -->
            <div class="reply-list">
                {% for comment in reply_list %}
                <div class="child-comment">
                    <div class="col-sm-1 comment-avatar">
                        {% get_show_avatar comment.author %}
                    </div>
                    <div class="col-sm-11">
                        <span id="c{{ comment.pk }}">{{ comment.author.username }}</span>&nbsp;<span class="glyphicon glyphicon-share-alt"></span>&nbsp;<span>{{ comment.parent.author.username }}</span>
                        <span class="pull-right">{{ comment.created }}</span>
                        <div class="comment-content">{{ comment.content|safe }}</div>
                        <span><a href="javascript:void(0);" class="pull-right reply" id="{{ comment.pk }}">回复</a></span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% empty %}
            <div class="no-comment">
                <p>暂无评论</p>
            </div>
            {% endfor %}
        </div>

        <!-- 暂时用crispy取代
    <form action="{% url 'post_detail' post.pk %}" method="POST" id="comment-form">
        {% csrf_token %}
        {% crispy form %}
        <div class="form-group pull-right">
            <button type="button" class="btn btn-danger btn-md" id="cancel-reply">取消回复</button>&nbsp;
            <button type="submit" class="btn btn-primary btn-md">提交评论</button>
        </div>
    </form>
    -->
    </div>
</div>

{% endblock %}
